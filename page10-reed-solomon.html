<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Page 10 - Reed-Solomon (204,188)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 {
            color: #00d4ff;
            text-align: center;
        }
        .description {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #00d4ff;
        }
        .pipeline {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
            flex-wrap: wrap;
        }
        .pipeline-step {
            background: #0f3460;
            padding: 8px 15px;
            border-radius: 5px;
        }
        .pipeline-step.active {
            background: #00d4ff;
            color: #000;
        }
        .pipeline-step.done {
            background: #006644;
        }
        .pipeline-arrow {
            color: #00d4ff;
            font-size: 20px;
        }
        .canvas-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .canvas-box {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .canvas-box h3 {
            margin-top: 0;
            color: #00d4ff;
        }
        canvas {
            border: 2px solid #0f3460;
            cursor: pointer;
        }
        .controls {
            margin-top: 10px;
        }
        button {
            background: #0f3460;
            color: #fff;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #00d4ff;
            color: #000;
        }
        button:disabled {
            background: #333;
            cursor: not-allowed;
        }
        input[type="file"] {
            display: none;
        }
        .info {
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }
        .stats {
            background: #0f3460;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 12px;
            text-align: left;
        }
        .detail-section {
            max-width: 1100px;
            margin: 20px auto;
        }
        .hex-display {
            font-family: monospace;
            font-size: 11px;
            background: #0a0a15;
            padding: 10px;
            border-radius: 5px;
            max-height: 120px;
            overflow-y: auto;
            word-break: break-all;
            text-align: left;
        }
        .hex-display .data { color: #00d4ff; }
        .hex-display .parity { color: #ff8800; }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 10px;
        }
        .legend-color {
            width: 16px;
            height: 12px;
            border-radius: 2px;
        }
        .section-detail {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .section-detail h4 {
            margin-top: 0;
            color: #00d4ff;
        }
        .field-list {
            font-family: monospace;
            font-size: 11px;
            line-height: 1.6;
        }
        .field-list .field-name { color: #ff8800; }
        .field-list .field-value { color: #00ff88; }
        .rs-diagram {
            font-family: monospace;
            font-size: 11px;
            background: #0a0a15;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        table.info-table {
            border-collapse: collapse;
            font-size: 11px;
            width: 100%;
            margin: 10px 0;
        }
        table.info-table th, table.info-table td {
            border: 1px solid #333;
            padding: 5px 8px;
            text-align: left;
        }
        table.info-table th {
            background: #0f3460;
        }
        .poly-display {
            font-family: monospace;
            font-size: 10px;
            background: #0a0a15;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Page 10 - Reed-Solomon (204,188)</h1>
    
    <div class="description">
        <strong>Fonction :</strong> Encodage Reed-Solomon selon DVB-S EN 300 421.<br>
        Code RS(204,188) raccourci de RS(255,239) ‚Äî Correction jusqu'√† <strong>8 octets erron√©s</strong> par bloc.<br>
        <strong>GF(2‚Å∏)</strong> avec polyn√¥me primitif p(x) = x‚Å∏ + x‚Å¥ + x¬≥ + x¬≤ + 1 (0x11D)<br>
        <strong>Entr√©e :</strong> Paquets TS randomis√©s (188 octets) ‚Äî <strong>Sortie :</strong> Blocs RS (204 octets)
    </div>
    
    <div class="pipeline">
        <span class="pipeline-step done">TS</span>
        <span class="pipeline-arrow">‚Üí</span>
        <span class="pipeline-step done">PRBS</span>
        <span class="pipeline-arrow">‚Üí</span>
        <span class="pipeline-step active">Reed-Solomon</span>
        <span class="pipeline-arrow">‚Üí</span>
        <span class="pipeline-step">Entrelacement</span>
        <span class="pipeline-arrow">‚Üí</span>
        <span class="pipeline-step">Viterbi</span>
        <span class="pipeline-arrow">‚Üí</span>
        <span class="pipeline-step">QPSK</span>
    </div>
    
    <div class="canvas-container">
        <!-- CANVAS 1 : TS randomis√© en entr√©e -->
        <div class="canvas-box">
            <h3>1. ENTR√âE - TS Randomis√©</h3>
            <canvas id="canvasInput" width="352" height="288"></canvas>
            <div class="controls">
                <button onclick="document.getElementById('fileInput').click()">üìÅ Charger JSON</button>
                <input type="file" id="fileInput" accept=".json" onchange="loadJSON(this.files)">
            </div>
            <div class="info">Paquets 188 octets (sortie Page 09)</div>
            <div id="statsInput" class="stats" style="display:none;"></div>
        </div>
        
        <!-- CANVAS 2 : Processus RS -->
        <div class="canvas-box">
            <h3>2. TRAITEMENT - Encodage RS</h3>
            <canvas id="canvasProcess" width="352" height="288"></canvas>
            <div class="controls">
                <button id="btnEncode" onclick="encodeRS()" disabled>‚öôÔ∏è Encoder RS</button>
                <button id="btnAnimate" onclick="animateRS()" disabled>‚ñ∂Ô∏è Animer</button>
                <button id="btnStop" onclick="stopAnimation()" disabled>‚èπÔ∏è Stop</button>
            </div>
            <div class="info">Division polynomiale dans GF(2‚Å∏)</div>
        </div>
        
        <!-- CANVAS 3 : Blocs RS -->
        <div class="canvas-box">
            <h3>3. SORTIE - Blocs RS (204 oct)</h3>
            <canvas id="canvasOutput" width="352" height="288"></canvas>
            <div class="controls">
                <button id="btnExportJSON" onclick="exportJSON()" disabled>üíæ JSON</button>
                <button id="btnExportBin" onclick="exportBinary()" disabled>üíæ .rs</button>
            </div>
            <div class="info">Cliquez sur un bloc pour le d√©tail</div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:#0099cc"></div> Donn√©es (188)</div>
                <div class="legend-item"><div class="legend-color" style="background:#ff8800"></div> Parit√© (16)</div>
            </div>
        </div>
    </div>
    
    <!-- D√©tails -->
    <div class="detail-section">
        <div id="blockDetail" class="section-detail" style="display:none;">
            <h4 id="detailTitle">Bloc RS</h4>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 280px;">
                    <strong>Donn√©es (188 octets) :</strong>
                    <div id="detailData" class="hex-display"></div>
                </div>
                <div style="flex: 1; min-width: 280px;">
                    <strong>Parit√© RS (16 octets) :</strong>
                    <div id="detailParity" class="hex-display"></div>
                </div>
            </div>
            <div id="detailStats" style="margin-top: 10px; font-size: 11px; color: #888;"></div>
        </div>
        
        <div id="globalStats" class="stats" style="display:none; margin-top: 15px;"></div>
        
        <h4 style="color: #00d4ff; margin-top: 20px;">Polyn√¥me G√©n√©rateur g(x)</h4>
        <div class="poly-display">
            g(x) = x¬π‚Å∂ + 0x3B¬∑x¬π‚Åµ + 0x0D¬∑x¬π‚Å¥ + 0x68¬∑x¬π¬≥ + 0xBD¬∑x¬π¬≤ + 0x44¬∑x¬π¬π + 0xD1¬∑x¬π‚Å∞ + 0x1E¬∑x‚Åπ + 0x08¬∑x‚Å∏ + 0xA3¬∑x‚Å∑ + 0x41¬∑x‚Å∂ + 0x29¬∑x‚Åµ + 0xE5¬∑x‚Å¥ + 0x62¬∑x¬≥ + 0x32¬∑x¬≤ + 0x24¬∑x + 0x3B
        </div>
        <p style="font-size: 11px; color: #888;">g(x) = ‚àè(x - Œ±^i) pour i = 0..15, o√π Œ± est racine primitive de GF(2‚Å∏)</p>
        
        <h4 style="color: #00d4ff; margin-top: 20px;">Structure RS(204,188)</h4>
        <div class="rs-diagram">
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                              Bloc RS : 204 octets                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Donn√©es (message)                                          ‚îÇ  Parit√© (redundancy)  ‚îÇ
‚îÇ  188 octets                                                 ‚îÇ  16 octets            ‚îÇ
‚îÇ  [D‚ÇÄ, D‚ÇÅ, D‚ÇÇ, ..., D‚ÇÅ‚Çà‚ÇÜ, D‚ÇÅ‚Çà‚Çá]                             ‚îÇ  [P‚ÇÄ, P‚ÇÅ, ..., P‚ÇÅ‚ÇÖ]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  = Paquet TS randomis√© (sync 0xB8 ou 0x47 + 187 octets)    ‚îÇ  = Reste de m(x)¬∑x¬π‚Å∂  ‚îÇ
‚îÇ                                                             ‚îÇ    mod g(x)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Encodage syst√©matique :
  ‚Ä¢ m(x) = polyn√¥me message (donn√©es)
  ‚Ä¢ Calculer r(x) = m(x)¬∑x¬π‚Å∂ mod g(x)
  ‚Ä¢ Mot de code c(x) = m(x)¬∑x¬π‚Å∂ + r(x)

Capacit√© de correction : t = 8 octets erron√©s par bloc de 204
        </div>
        
        <h4 style="color: #00d4ff; margin-top: 20px;">Param√®tres DVB-S</h4>
        <table class="info-table">
            <tr>
                <th>Param√®tre</th>
                <th>Valeur</th>
                <th>Description</th>
            </tr>
            <tr>
                <td>Code</td>
                <td>RS(204,188)</td>
                <td>Raccourci de RS(255,239)</td>
            </tr>
            <tr>
                <td>Symboles</td>
                <td>GF(2‚Å∏)</td>
                <td>Octets (8 bits)</td>
            </tr>
            <tr>
                <td>Polyn√¥me primitif</td>
                <td>p(x) = x‚Å∏+x‚Å¥+x¬≥+x¬≤+1</td>
                <td>0x11D</td>
            </tr>
            <tr>
                <td>Parit√©</td>
                <td>16 octets</td>
                <td>2t symboles</td>
            </tr>
            <tr>
                <td>Correction</td>
                <td>t = 8</td>
                <td>Jusqu'√† 8 octets erron√©s</td>
            </tr>
            <tr>
                <td>Rendement</td>
                <td>188/204 = 92.2%</td>
                <td>Overhead 8.5%</td>
            </tr>
        </table>
    </div>

    <script>
        // ============================================================
        // CONSTANTES
        // ============================================================
        
        const WIDTH = 352;
        const HEIGHT = 288;
        
        const TS_PACKET_SIZE = 188;
        const RS_BLOCK_SIZE = 204;
        const RS_PARITY_SIZE = 16;  // 2t = 16
        const RS_T = 8;             // Capacit√© de correction
        
        // ============================================================
        // TABLES GF(2^8) - Polyn√¥me primitif 0x11D
        // ============================================================
        
        const LOG_TABLE = [
            -1, 0, 1, 25, 2, 50, 26, 198, 3, 223, 51, 238, 27, 104, 199, 75,
            4, 100, 224, 14, 52, 141, 239, 129, 28, 193, 105, 248, 200, 8, 76, 113,
            5, 138, 101, 47, 225, 36, 15, 33, 53, 147, 142, 218, 240, 18, 130, 69,
            29, 181, 194, 125, 106, 39, 249, 185, 201, 154, 9, 120, 77, 228, 114, 166,
            6, 191, 139, 98, 102, 221, 48, 253, 226, 152, 37, 179, 16, 145, 34, 136,
            54, 208, 148, 206, 143, 150, 219, 189, 241, 210, 19, 92, 131, 56, 70, 64,
            30, 66, 182, 163, 195, 72, 126, 110, 107, 58, 40, 84, 250, 133, 186, 61,
            202, 94, 155, 159, 10, 21, 121, 43, 78, 212, 229, 172, 115, 243, 167, 87,
            7, 112, 192, 247, 140, 128, 99, 13, 103, 74, 222, 237, 49, 197, 254, 24,
            227, 165, 153, 119, 38, 184, 180, 124, 17, 68, 146, 217, 35, 32, 137, 46,
            55, 63, 209, 91, 149, 188, 207, 205, 144, 135, 151, 178, 220, 252, 190, 97,
            242, 86, 211, 171, 20, 42, 93, 158, 132, 60, 57, 83, 71, 109, 65, 162,
            31, 45, 67, 216, 183, 123, 164, 118, 196, 23, 73, 236, 127, 12, 111, 246,
            108, 161, 59, 82, 41, 157, 85, 170, 251, 96, 134, 177, 187, 204, 62, 90,
            203, 89, 95, 176, 156, 169, 160, 81, 11, 245, 22, 235, 122, 117, 44, 215,
            79, 174, 213, 233, 230, 231, 173, 232, 116, 214, 244, 234, 168, 80, 88, 175
        ];
        
        const ANTILOG_TABLE = [
            0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x1D, 0x3A, 0x74, 0xE8, 0xCD, 0x87, 0x13, 0x26,
            0x4C, 0x98, 0x2D, 0x5A, 0xB4, 0x75, 0xEA, 0xC9, 0x8F, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0,
            0x9D, 0x27, 0x4E, 0x9C, 0x25, 0x4A, 0x94, 0x35, 0x6A, 0xD4, 0xB5, 0x77, 0xEE, 0xC1, 0x9F, 0x23,
            0x46, 0x8C, 0x05, 0x0A, 0x14, 0x28, 0x50, 0xA0, 0x5D, 0xBA, 0x69, 0xD2, 0xB9, 0x6F, 0xDE, 0xA1,
            0x5F, 0xBE, 0x61, 0xC2, 0x99, 0x2F, 0x5E, 0xBC, 0x65, 0xCA, 0x89, 0x0F, 0x1E, 0x3C, 0x78, 0xF0,
            0xFD, 0xE7, 0xD3, 0xBB, 0x6B, 0xD6, 0xB1, 0x7F, 0xFE, 0xE1, 0xDF, 0xA3, 0x5B, 0xB6, 0x71, 0xE2,
            0xD9, 0xAF, 0x43, 0x86, 0x11, 0x22, 0x44, 0x88, 0x0D, 0x1A, 0x34, 0x68, 0xD0, 0xBD, 0x67, 0xCE,
            0x81, 0x1F, 0x3E, 0x7C, 0xF8, 0xED, 0xC7, 0x93, 0x3B, 0x76, 0xEC, 0xC5, 0x97, 0x33, 0x66, 0xCC,
            0x85, 0x17, 0x2E, 0x5C, 0xB8, 0x6D, 0xDA, 0xA9, 0x4F, 0x9E, 0x21, 0x42, 0x84, 0x15, 0x2A, 0x54,
            0xA8, 0x4D, 0x9A, 0x29, 0x52, 0xA4, 0x55, 0xAA, 0x49, 0x92, 0x39, 0x72, 0xE4, 0xD5, 0xB7, 0x73,
            0xE6, 0xD1, 0xBF, 0x63, 0xC6, 0x91, 0x3F, 0x7E, 0xFC, 0xE5, 0xD7, 0xB3, 0x7B, 0xF6, 0xF1, 0xFF,
            0xE3, 0xDB, 0xAB, 0x4B, 0x96, 0x31, 0x62, 0xC4, 0x95, 0x37, 0x6E, 0xDC, 0xA5, 0x57, 0xAE, 0x41,
            0x82, 0x19, 0x32, 0x64, 0xC8, 0x8D, 0x07, 0x0E, 0x1C, 0x38, 0x70, 0xE0, 0xDD, 0xA7, 0x53, 0xA6,
            0x51, 0xA2, 0x59, 0xB2, 0x79, 0xF2, 0xF9, 0xEF, 0xC3, 0x9B, 0x2B, 0x56, 0xAC, 0x45, 0x8A, 0x09,
            0x12, 0x24, 0x48, 0x90, 0x3D, 0x7A, 0xF4, 0xF5, 0xF7, 0xF3, 0xFB, 0xEB, 0xCB, 0x8B, 0x0B, 0x16,
            0x2C, 0x58, 0xB0, 0x7D, 0xFA, 0xE9, 0xCF, 0x83, 0x1B, 0x36, 0x6C, 0xD8, 0xAD, 0x47, 0x8E, 0x01,
            // √âtendue pour √©viter modulo (indices 256-511 = copie de 0-255)
            0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x1D, 0x3A, 0x74, 0xE8, 0xCD, 0x87, 0x13, 0x26, 0x4C,
            0x98, 0x2D, 0x5A, 0xB4, 0x75, 0xEA, 0xC9, 0x8F, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x9D,
            0x27, 0x4E, 0x9C, 0x25, 0x4A, 0x94, 0x35, 0x6A, 0xD4, 0xB5, 0x77, 0xEE, 0xC1, 0x9F, 0x23, 0x46,
            0x8C, 0x05, 0x0A, 0x14, 0x28, 0x50, 0xA0, 0x5D, 0xBA, 0x69, 0xD2, 0xB9, 0x6F, 0xDE, 0xA1, 0x5F,
            0xBE, 0x61, 0xC2, 0x99, 0x2F, 0x5E, 0xBC, 0x65, 0xCA, 0x89, 0x0F, 0x1E, 0x3C, 0x78, 0xF0, 0xFD,
            0xE7, 0xD3, 0xBB, 0x6B, 0xD6, 0xB1, 0x7F, 0xFE, 0xE1, 0xDF, 0xA3, 0x5B, 0xB6, 0x71, 0xE2, 0xD9,
            0xAF, 0x43, 0x86, 0x11, 0x22, 0x44, 0x88, 0x0D, 0x1A, 0x34, 0x68, 0xD0, 0xBD, 0x67, 0xCE, 0x81,
            0x1F, 0x3E, 0x7C, 0xF8, 0xED, 0xC7, 0x93, 0x3B, 0x76, 0xEC, 0xC5, 0x97, 0x33, 0x66, 0xCC, 0x85,
            0x17, 0x2E, 0x5C, 0xB8, 0x6D, 0xDA, 0xA9, 0x4F, 0x9E, 0x21, 0x42, 0x84, 0x15, 0x2A, 0x54, 0xA8,
            0x4D, 0x9A, 0x29, 0x52, 0xA4, 0x55, 0xAA, 0x49, 0x92, 0x39, 0x72, 0xE4, 0xD5, 0xB7, 0x73, 0xE6,
            0xD1, 0xBF, 0x63, 0xC6, 0x91, 0x3F, 0x7E, 0xFC, 0xE5, 0xD7, 0xB3, 0x7B, 0xF6, 0xF1, 0xFF, 0xE3,
            0xDB, 0xAB, 0x4B, 0x96, 0x31, 0x62, 0xC4, 0x95, 0x37, 0x6E, 0xDC, 0xA5, 0x57, 0xAE, 0x41, 0x82,
            0x19, 0x32, 0x64, 0xC8, 0x8D, 0x07, 0x0E, 0x1C, 0x38, 0x70, 0xE0, 0xDD, 0xA7, 0x53, 0xA6, 0x51,
            0xA2, 0x59, 0xB2, 0x79, 0xF2, 0xF9, 0xEF, 0xC3, 0x9B, 0x2B, 0x56, 0xAC, 0x45, 0x8A, 0x09, 0x12,
            0x24, 0x48, 0x90, 0x3D, 0x7A, 0xF4, 0xF5, 0xF7, 0xF3, 0xFB, 0xEB, 0xCB, 0x8B, 0x0B, 0x16, 0x2C,
            0x58, 0xB0, 0x7D, 0xFA, 0xE9, 0xCF, 0x83, 0x1B, 0x36, 0x6C, 0xD8, 0xAD, 0x47, 0x8E, 0x01, 0x02
        ];
        
        // Polyn√¥me g√©n√©rateur g(x) pour t=8 (16 symboles de parit√©)
        // g(x) = (x-Œ±‚Å∞)(x-Œ±¬π)...(x-Œ±¬π‚Åµ)
        // Coefficients du plus haut degr√© au plus bas
        const GENERATOR_POLY = [
            1, 0x3B, 0x0D, 0x68, 0xBD, 0x44, 0xD1, 0x1E,
            0x08, 0xA3, 0x41, 0x29, 0xE5, 0x62, 0x32, 0x24, 0x3B
        ];
        
        // ============================================================
        // ARITHM√âTIQUE GF(2^8)
        // ============================================================
        
        function gf_add(a, b) {
            return a ^ b;
        }
        
        function gf_mult(a, b) {
            if (a === 0 || b === 0) return 0;
            return ANTILOG_TABLE[LOG_TABLE[a] + LOG_TABLE[b]];
        }
        
        function gf_div(a, b) {
            if (b === 0) throw "Division par z√©ro dans GF(2^8)";
            if (a === 0) return 0;
            return ANTILOG_TABLE[(LOG_TABLE[a] - LOG_TABLE[b] + 255) % 255];
        }
        
        function gf_pow(a, power) {
            if (a === 0) return 0;
            return ANTILOG_TABLE[(LOG_TABLE[a] * power) % 255];
        }
        
        // ============================================================
        // VARIABLES GLOBALES
        // ============================================================
        
        let inputData = null;
        let tsPackets = [];
        let rsBlocks = [];
        let encoded = false;
        let selectedBlock = null;
        let animationId = null;
        
        // ============================================================
        // INITIALISATION
        // ============================================================
        
        window.onload = function() {
            clearCanvas('canvasInput');
            displayProcessInit();
            clearCanvas('canvasOutput');
        };
        
        // ============================================================
        // CHARGEMENT JSON
        // ============================================================
        
        function loadJSON(files) {
            if (!files || files.length === 0) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    inputData = JSON.parse(e.target.result);
                    
                    if (!inputData.format || inputData.format !== 'DVB_RANDOMIZED_V1') {
                        alert('Format non reconnu. Utilisez la sortie de Page 09.');
                        return;
                    }
                    
                    // D√©coder le binaire base64
                    const binaryString = atob(inputData.binary);
                    const tsBinary = [];
                    for (let i = 0; i < binaryString.length; i++) {
                        tsBinary.push(binaryString.charCodeAt(i));
                    }
                    
                    // Reconstruire les paquets
                    tsPackets = [];
                    for (let i = 0; i < tsBinary.length; i += TS_PACKET_SIZE) {
                        tsPackets.push({
                            index: tsPackets.length,
                            bytes: tsBinary.slice(i, i + TS_PACKET_SIZE)
                        });
                    }
                    
                    rsBlocks = [];
                    encoded = false;
                    selectedBlock = null;
                    
                    displayInputTS();
                    displayProcessInit();
                    clearCanvas('canvasOutput');
                    
                    document.getElementById('btnEncode').disabled = false;
                    document.getElementById('btnAnimate').disabled = false;
                    document.getElementById('btnExportJSON').disabled = true;
                    document.getElementById('btnExportBin').disabled = true;
                    document.getElementById('blockDetail').style.display = 'none';
                    document.getElementById('globalStats').style.display = 'none';
                    
                    const stats = document.getElementById('statsInput');
                    stats.style.display = 'block';
                    stats.innerHTML = `
                        <strong>TS Randomis√© charg√© :</strong><br>
                        ‚Ä¢ Paquets : ${tsPackets.length}<br>
                        ‚Ä¢ Taille : ${tsBinary.length.toLocaleString()} octets<br>
                        ‚Ä¢ ‚Üí Blocs RS : ${tsPackets.length} √ó 204 = ${tsPackets.length * RS_BLOCK_SIZE} octets
                    `;
                    
                } catch (err) {
                    alert('Erreur JSON : ' + err.message);
                }
            };
            reader.readAsText(files[0]);
        }
        
        // ============================================================
        // AFFICHAGE TS ENTR√âE
        // ============================================================
        
        function displayInputTS() {
            const canvas = document.getElementById('canvasInput');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, WIDTH, HEIGHT);
            
            ctx.font = 'bold 12px Arial';
            ctx.fillStyle = '#00d4ff';
            ctx.textAlign = 'center';
            ctx.fillText(`${tsPackets.length} paquets TS (188 oct)`, WIDTH / 2, 20);
            
            // Afficher les paquets
            const packetsPerRow = 11;
            const packetWidth = 30;
            const packetHeight = 20;
            const startY = 35;
            
            for (let i = 0; i < tsPackets.length; i++) {
                const row = Math.floor(i / packetsPerRow);
                const col = i % packetsPerRow;
                
                const x = 10 + col * (packetWidth + 2);
                const y = startY + row * (packetHeight + 5);
                
                if (y + packetHeight > HEIGHT - 20) break;
                
                // Paquet TS
                ctx.fillStyle = '#0099cc';
                ctx.fillRect(x, y, packetWidth, packetHeight);
                
                // Num√©ro
                ctx.fillStyle = '#fff';
                ctx.font = '9px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(i.toString(), x + packetWidth / 2, y + packetHeight / 2 + 3);
            }
            
            ctx.fillStyle = '#888';
            ctx.font = '10px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Chaque paquet ‚Üí 1 bloc RS', 10, HEIGHT - 10);
        }
        
        // ============================================================
        // AFFICHAGE PROCESS
        // ============================================================
        
        function displayProcessInit() {
            const canvas = document.getElementById('canvasProcess');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, WIDTH, HEIGHT);
            
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = '#00d4ff';
            ctx.textAlign = 'center';
            ctx.fillText('Encodage Reed-Solomon', WIDTH / 2, 25);
            
            // Sch√©ma
            ctx.font = '11px Arial';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#fff';
            
            let y = 50;
            ctx.fillText('1. Message m(x) = 188 octets donn√©es', 20, y);
            ctx.fillStyle = '#888';
            ctx.fillText('   m(x) = m‚ÇÅ‚Çà‚Çá¬∑x¬π‚Å∏‚Å∑ + ... + m‚ÇÅ¬∑x + m‚ÇÄ', 20, y + 15);
            
            y += 40;
            ctx.fillStyle = '#fff';
            ctx.fillText('2. D√©caler de 16 positions : m(x)¬∑x¬π‚Å∂', 20, y);
            ctx.fillStyle = '#888';
            ctx.fillText('   Faire place pour les 16 octets de parit√©', 20, y + 15);
            
            y += 40;
            ctx.fillStyle = '#fff';
            ctx.fillText('3. Division polynomiale dans GF(2‚Å∏)', 20, y);
            ctx.fillStyle = '#888';
            ctx.fillText('   r(x) = m(x)¬∑x¬π‚Å∂ mod g(x)', 20, y + 15);
            ctx.fillText('   r(x) = reste = 16 octets de parit√©', 20, y + 30);
            
            y += 50;
            ctx.fillStyle = '#fff';
            ctx.fillText('4. Mot de code = donn√©es + parit√©', 20, y);
            ctx.fillStyle = '#888';
            ctx.fillText('   c(x) = m(x)¬∑x¬π‚Å∂ + r(x)', 20, y + 15);
            
            // Visualisation
            y += 45;
            ctx.fillStyle = '#0099cc';
            ctx.fillRect(20, y, 200, 20);
            ctx.fillStyle = '#ff8800';
            ctx.fillRect(220, y, 50, 20);
            
            ctx.fillStyle = '#fff';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('188 octets donn√©es', 120, y + 14);
            ctx.fillText('16 parit√©', 245, y + 14);
            
            ctx.fillStyle = '#888';
            ctx.font = '9px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('= 204 octets total', 280, y + 14);
        }
        
        // ============================================================
        // ENCODAGE RS
        // ============================================================
        
        function encodeRS() {
            if (!tsPackets.length) return;
            
            rsBlocks = [];
            
            for (let i = 0; i < tsPackets.length; i++) {
                const packet = tsPackets[i];
                const rsBlock = encodeRSBlock(packet.bytes);
                rsBlocks.push({
                    index: i,
                    data: packet.bytes,
                    parity: rsBlock.parity,
                    bytes: rsBlock.codeword
                });
            }
            
            encoded = true;
            displayOutputRS();
            
            document.getElementById('btnExportJSON').disabled = false;
            document.getElementById('btnExportBin').disabled = false;
            
            // Stats
            const totalInput = tsPackets.length * TS_PACKET_SIZE;
            const totalOutput = rsBlocks.length * RS_BLOCK_SIZE;
            const overhead = totalOutput - totalInput;
            
            const globalStats = document.getElementById('globalStats');
            globalStats.style.display = 'block';
            globalStats.innerHTML = `
                <strong>Encodage RS termin√© :</strong><br>
                ‚Ä¢ Blocs RS cr√©√©s : ${rsBlocks.length}<br>
                ‚Ä¢ Taille entr√©e : ${totalInput.toLocaleString()} octets<br>
                ‚Ä¢ Taille sortie : ${totalOutput.toLocaleString()} octets<br>
                ‚Ä¢ Parit√© ajout√©e : ${overhead} octets (${(overhead / totalInput * 100).toFixed(1)}%)<br>
                ‚Ä¢ Capacit√© correction : ${RS_T} octets/bloc
            `;
        }
        
        function encodeRSBlock(data) {
            // Encodage syst√©matique RS(204,188)
            // 1. Le message est d√©j√† les 188 octets de donn√©es
            // 2. On calcule r(x) = m(x)¬∑x^16 mod g(x)
            
            // Registre de feedback (16 octets pour la parit√©)
            const feedback = new Array(RS_PARITY_SIZE).fill(0);
            
            // Division polynomiale
            for (let i = 0; i < data.length; i++) {
                const inputByte = data[i];
                const feedback0 = gf_add(inputByte, feedback[0]);
                
                // D√©caler le registre et ajouter les termes de feedback
                for (let j = 0; j < RS_PARITY_SIZE - 1; j++) {
                    feedback[j] = gf_add(feedback[j + 1], gf_mult(feedback0, GENERATOR_POLY[j + 1]));
                }
                feedback[RS_PARITY_SIZE - 1] = gf_mult(feedback0, GENERATOR_POLY[RS_PARITY_SIZE]);
            }
            
            // Le feedback contient maintenant la parit√© (dans l'ordre inverse)
            const parity = feedback.slice().reverse();
            
            // Mot de code = donn√©es + parit√©
            const codeword = [...data, ...parity];
            
            return { parity, codeword };
        }
        
        // ============================================================
        // ANIMATION RS
        // ============================================================
        
        function animateRS() {
            if (animationId || !tsPackets.length) return;
            
            const data = tsPackets[0].bytes;
            const feedback = new Array(RS_PARITY_SIZE).fill(0);
            let step = 0;
            
            document.getElementById('btnAnimate').disabled = true;
            document.getElementById('btnStop').disabled = false;
            
            function animate() {
                const canvas = document.getElementById('canvasProcess');
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, WIDTH, HEIGHT);
                
                ctx.font = 'bold 14px Arial';
                ctx.fillStyle = '#00d4ff';
                ctx.textAlign = 'center';
                ctx.fillText(`Encodage bloc 0 - Octet ${step}/${data.length}`, WIDTH / 2, 25);
                
                // Afficher l'octet courant
                if (step < data.length) {
                    ctx.font = '12px monospace';
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'left';
                    ctx.fillText(`Entr√©e: 0x${data[step].toString(16).toUpperCase().padStart(2, '0')}`, 20, 50);
                    
                    // Calcul
                    const inputByte = data[step];
                    const feedback0 = gf_add(inputByte, feedback[0]);
                    ctx.fillText(`Feedback: 0x${feedback0.toString(16).toUpperCase().padStart(2, '0')}`, 150, 50);
                    
                    // Mettre √† jour
                    for (let j = 0; j < RS_PARITY_SIZE - 1; j++) {
                        feedback[j] = gf_add(feedback[j + 1], gf_mult(feedback0, GENERATOR_POLY[j + 1]));
                    }
                    feedback[RS_PARITY_SIZE - 1] = gf_mult(feedback0, GENERATOR_POLY[RS_PARITY_SIZE]);
                }
                
                // Afficher le registre
                const regY = 80;
                ctx.fillStyle = '#666';
                ctx.fillRect(10, regY, WIDTH - 20, 30);
                
                const cellWidth = (WIDTH - 20) / RS_PARITY_SIZE;
                for (let i = 0; i < RS_PARITY_SIZE; i++) {
                    ctx.fillStyle = feedback[i] === 0 ? '#333' : '#ff8800';
                    ctx.fillRect(10 + i * cellWidth + 1, regY + 1, cellWidth - 2, 28);
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = '9px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(feedback[i].toString(16).toUpperCase().padStart(2, '0'), 
                                 10 + i * cellWidth + cellWidth / 2, regY + 18);
                }
                
                // Barre de progression
                ctx.fillStyle = '#0f3460';
                ctx.fillRect(10, 130, WIDTH - 20, 15);
                ctx.fillStyle = '#00d4ff';
                ctx.fillRect(10, 130, (WIDTH - 20) * (step / data.length), 15);
                
                ctx.fillStyle = '#fff';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${Math.round(step / data.length * 100)}%`, WIDTH / 2, 142);
                
                step++;
                
                if (step <= data.length) {
                    animationId = setTimeout(animate, 10);
                } else {
                    // Afficher la parit√© finale
                    ctx.fillStyle = '#00ff88';
                    ctx.font = '12px monospace';
                    ctx.textAlign = 'left';
                    ctx.fillText('Parit√© calcul√©e:', 20, 170);
                    
                    const parity = feedback.slice().reverse();
                    let parityStr = '';
                    for (let i = 0; i < parity.length; i++) {
                        parityStr += parity[i].toString(16).toUpperCase().padStart(2, '0') + ' ';
                    }
                    ctx.fillText(parityStr, 20, 190);
                    
                    stopAnimation();
                    encodeRS();
                }
            }
            
            animate();
        }
        
        function stopAnimation() {
            if (animationId) {
                clearTimeout(animationId);
                animationId = null;
            }
            document.getElementById('btnAnimate').disabled = false;
            document.getElementById('btnStop').disabled = true;
        }
        
        // ============================================================
        // AFFICHAGE BLOCS RS
        // ============================================================
        
        function displayOutputRS() {
            const canvas = document.getElementById('canvasOutput');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, WIDTH, HEIGHT);
            
            ctx.font = 'bold 12px Arial';
            ctx.fillStyle = '#00d4ff';
            ctx.textAlign = 'center';
            ctx.fillText(`${rsBlocks.length} blocs RS (204 oct)`, WIDTH / 2, 20);
            
            // Afficher les blocs
            const blocksPerRow = 8;
            const blockWidth = 40;
            const blockHeight = 25;
            const startY = 35;
            
            for (let i = 0; i < rsBlocks.length; i++) {
                const row = Math.floor(i / blocksPerRow);
                const col = i % blocksPerRow;
                
                const x = 10 + col * (blockWidth + 3);
                const y = startY + row * (blockHeight + 8);
                
                if (y + blockHeight > HEIGHT - 20) break;
                
                // Donn√©es (188)
                const dataWidth = blockWidth * (188 / 204);
                ctx.fillStyle = '#0099cc';
                ctx.fillRect(x, y, dataWidth, blockHeight);
                
                // Parit√© (16)
                ctx.fillStyle = '#ff8800';
                ctx.fillRect(x + dataWidth, y, blockWidth - dataWidth, blockHeight);
                
                // S√©lection
                if (selectedBlock === i) {
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, blockWidth, blockHeight);
                }
                
                // Num√©ro
                ctx.fillStyle = '#fff';
                ctx.font = '9px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(i.toString(), x + blockWidth / 2, y + blockHeight / 2 + 3);
                
                // Stocker pour clic
                rsBlocks[i].displayX = x;
                rsBlocks[i].displayY = y;
                rsBlocks[i].displayWidth = blockWidth;
                rsBlocks[i].displayHeight = blockHeight;
            }
        }
        
        // ============================================================
        // CLIC SUR BLOC
        // ============================================================
        
        document.getElementById('canvasOutput').addEventListener('click', function(e) {
            if (!encoded) return;
            
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            for (let i = 0; i < rsBlocks.length; i++) {
                const block = rsBlocks[i];
                if (x >= block.displayX && x < block.displayX + block.displayWidth &&
                    y >= block.displayY && y < block.displayY + block.displayHeight) {
                    selectedBlock = i;
                    displayOutputRS();
                    displayBlockDetail(block);
                    return;
                }
            }
        });
        
        function displayBlockDetail(block) {
            const detailDiv = document.getElementById('blockDetail');
            detailDiv.style.display = 'block';
            
            document.getElementById('detailTitle').textContent = 
                `Bloc RS #${block.index} ‚Äî 204 octets (188 data + 16 parit√©)`;
            
            // Donn√©es
            const dataDiv = document.getElementById('detailData');
            let dataHtml = '';
            for (let i = 0; i < block.data.length; i++) {
                const hex = block.data[i].toString(16).toUpperCase().padStart(2, '0');
                dataHtml += `<span class="data">${hex}</span> `;
                if ((i + 1) % 16 === 0) dataHtml += '\n';
            }
            dataDiv.innerHTML = dataHtml;
            
            // Parit√©
            const parityDiv = document.getElementById('detailParity');
            let parityHtml = '';
            for (let i = 0; i < block.parity.length; i++) {
                const hex = block.parity[i].toString(16).toUpperCase().padStart(2, '0');
                parityHtml += `<span class="parity">${hex}</span> `;
            }
            parityDiv.innerHTML = parityHtml;
            
            // Stats
            document.getElementById('detailStats').innerHTML = 
                `Sync: 0x${block.data[0].toString(16).toUpperCase()} | ` +
                `Donn√©es: ${block.data.length} oct | Parit√©: ${block.parity.length} oct | ` +
                `Total: ${block.bytes.length} oct`;
        }
        
        // ============================================================
        // EXPORT
        // ============================================================
        
        function exportJSON() {
            if (!encoded) return;
            
            let rsBinary = [];
            for (const block of rsBlocks) {
                rsBinary.push(...block.bytes);
            }
            
            const output = {
                format: 'DVB_RS_V1',
                description: 'DVB-S Reed-Solomon RS(204,188)',
                date: new Date().toISOString(),
                source: inputData.format,
                image: inputData.image,
                rs: {
                    code: 'RS(204,188)',
                    primitivePolynomial: '0x11D',
                    t: RS_T,
                    parityBytes: RS_PARITY_SIZE,
                    blockCount: rsBlocks.length,
                    totalBytes: rsBinary.length,
                    generatorPoly: GENERATOR_POLY.map(c => '0x' + c.toString(16).toUpperCase())
                },
                randomization: inputData.randomization,
                ts: inputData.ts,
                binary: btoa(String.fromCharCode.apply(null, rsBinary))
            };
            
            const json = JSON.stringify(output, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rs_encoded.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportBinary() {
            if (!encoded) return;
            
            let rsBinary = [];
            for (const block of rsBlocks) {
                rsBinary.push(...block.bytes);
            }
            
            const blob = new Blob([new Uint8Array(rsBinary)], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'encoded.rs';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ============================================================
        // UTILITAIRES
        // ============================================================
        
        function clearCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, WIDTH, HEIGHT);
        }
    </script>
</body>
</html>
